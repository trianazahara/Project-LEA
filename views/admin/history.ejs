<%- include("../sidebar.ejs") %>
<div class="w-full pt-10 px-4 sm:px-6 md:px-8 lg:ps-72">
  <h3 class="font-bold md:text-xl md:leading-tight">Suplier</h3>
  
  <div class="max-w-[85rem] mx-auto py-10 px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col">
    <div class="-m-1.5 overflow-x-auto">
      <div class="p-1.5 min-w-full inline-block align-middle">
      <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 grid gap-3 md:flex md:justify-between md:items-center border-b border-gray-200">
          <div class="flex justify-between items-center mb-4">
            <!-- Search Input -->
            <input
              type="text"
              id="hs-as-table-product-review-search"
              name="hs-as-table-product-review-search"
              class="py-2 px-3 ps-11 block border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none"
              placeholder="Search"
            />
          
            <!-- Buttons Container -->
            <div>
              <button
                type="button"
                class="ml-2 py-2 px-4 bg-pink-300 text-white rounded-lg hover:bg-pink-300 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2"
              >
                Lihat
              </button>
              <button
                type="button"
                class="ml-2 py-2 px-4 bg-pink-300 text-white rounded-lg hover:bg-pink-300 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2"
              >
                + Tambah
              </button>
            </div>
          </div>
          
          </div>
        </div>
        </div>
  
        <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
          <th scope="col" class="px-4 py-2 text-start"><span class="font-semibold text-gray-800">Id Supllier</span></th>
          <th scope="col" class="px-4 py-2 text-start"><span class="font-semibold text-gray-800">Nama </span></th>
          <th scope="col" class="px-4 py-2 text-start"><span class="font-semibold text-gray-800">Alamat</span></th>
          <th scope="col" class="px-4 py-2 text-start"><span class="font-semibold text-gray-800">Kontak</span></th>
          <th scope="col" class="px-4 py-2 text-center"><span class="font-semibold text-gray-800">Aksi</span></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% permohonanBps.forEach(permohonanBp => { %>
          <% permohonanBp.Mahasiswa.Permohonans.forEach(permohonan => { %>
          <tr>
            <td class="px-4 py-2"><span class="text-gray-800"><%= permohonanBp.Mahasiswa.User.nama %></span></td>
            <td class="px-4 py-2"><span class="text-gray-800"><%= permohonanBp.Mahasiswa.User.username %></span></td>
            <td class="px-4 py-2"><span class="text-gray-800"><%= permohonanBp.Permohonan.departemen_tujuan %></span></td>
            <td class="px-4 py-2"><span class="text-gray-800"><%= permohonanBp.bpBaru %></span></td>
            <td class="px-4 py-2"><span class="text-gray-600"><%= formatDate(permohonanBp.createdAt) %></span></td>
            <td class="px-4 py-2"><span class="text-gray-600"><%= formatDate(permohonanBp.updatedAt) %></span></td>
            <td class="px-4 py-2"><span class="text-gray-600"><%= permohonanBp.status %></span></td>
            <td class="px-4 py-2">
            <div class="text-center">
              <button
              type="button"
              class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-white text-black hover:bg-white disabled:opacity-50 disabled:pointer-events-none"
              data-hs-overlay="#hs-modal-recover-account"
              data-permohonan-id="<%= permohonanBp.id %>"
              data-bp-lama="<%= permohonanBp.Mahasiswa.User.username %>"
              data-nim-baru="<%= permohonanBp.bpBaru %>"
              onclick="openModal(this)"
              >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-ellipsis"
              >
                <circle cx="12" cy="12" r="1" />
                <circle cx="19" cy="12" r="1" />
                <circle cx="5" cy="12" r="1" />
              </svg>
              </button>
            </div>
            </td>
          </tr>
          <% }) %>
          <% }) %>
        </tbody>
        </table>
        
        
      </div>
      </div>
    </div>
    </div>
  </div>
  
   
  
  <div id="hs-modal-recover-account" class="hs-overlay hidden size-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto">
      <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
      <div class="p-4 sm:p-7">
        <div class="text-center">
        <h2 class="block text-2xl font-bold text-gray-800">Ubah No Bp Mahasiswa</h2>
        </div>
        <div class="mt-5">
        <form id="nim-form" action="/admin/updateNim" method="post">
          <input type="hidden" name="permohonanBpId" id="permohonanBpId">
          <div class="grid gap-y-4">
          <div class="relative">
            <label for="bpLama" class="block text-sm font-medium text-gray-700">BP Lama</label>
            <input type="text" id="bpLama" name="bpLama" class="py-3 px-4 block w-full border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" required />
          </div>
          <div class="relative">
            <label for="nimBaru" class="block text-sm font-medium text-gray-700">NIM Baru</label>
            <input type="text" id="nimBaru" name="nimBaru" class="py-3 px-4 block w-full border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" required />
          </div>
          </div>
          <div class="flex justify-end items-center gap-x-2 p-4 sm:px-7">
          <button type="button" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none" data-hs-overlay="#hs-modal-recover-account">Cancel</button>
          <button id="submitBtn" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:pointer-events-none" type="submit">Submit</button>
          </div>
        </form>
        
        </div>
      </div>
      </div>
    </div>
    </div>

    <script src="/preline.js"></script>
    <script src="/sweetalert2.all.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('nim-form');
      
      form.addEventListener('submit', async function(e) {
      e.preventDefault();
    
      const permohonanBpId = document.getElementById('permohonanBpId').value;
      const nimBaru = document.getElementById('nimBaru').value;
    
      const result = await Swal.fire({
        title: 'Are you sure?',
        text: "You're about to update the NIM. This action cannot be undone.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!'
      });
    
      if (result.isConfirmed) {
        try {
        const response = await fetch('/admin/updateNim', {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json',
          },
          body: JSON.stringify({ permohonanBpId, nimBaru }),
        });
    
        const data = await response.json();
    
        if (response.ok) {
          Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: data.message,
          confirmButtonText: 'OK'
          }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/admin/request';
          }
          });
        } else {
          throw new Error(data.message || 'An error occurred');
        }
        } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: error.message,
        });
        }
      }
      });
    });
    </script>
    <script>
    function openModal(button) {
      const permohonanId = button.getAttribute('data-permohonan-id');
      const bpLama = button.getAttribute('data-bp-lama');
      const nimBaru = button.getAttribute('data-nim-baru');
    
      document.getElementById('permohonanBpId').value = permohonanId;
      document.getElementById('bpLama').value = bpLama;
      document.getElementById('nimBaru').value = nimBaru;
    }
    </script>
    
  
  
</body>
</html>
